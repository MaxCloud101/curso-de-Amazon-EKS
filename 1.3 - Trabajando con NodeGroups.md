# Trabajando con NodeGroups

Los nodegroups agrupan instancias EC2 con el mismo tipo de imagen (AMI) y rol de IAM. Estos se conectan al control plane de EKS para ejecutar cargas de trabajo en Kubernetes.

## NodeGroups:

Existen dos tipos de nodegroups:

- **Unmanaged Node Groups:** O simplemente llamados "Node Groups" o "Self-Managed Node Groups". Tienes control total sobre las instancias EC2, incluyendo el sistema operativo, la AMI y el software instalado. Esto permite una personalización exhaustiva para cumplir con requisitos específicos o políticas de seguridad.
- **Managed Node Groups:** AWS automatiza gran parte de la gestión del ciclo de vida de los nodos, incluyendo el aprovisionamiento, la aplicación de parches y el escalado. Esto reduce significativamente la sobrecarga operativa y simplifica la gestión de los nodos. (Te recomiendo esta opción, si no deseas correr componentes especiales en tus instancias)

Por diseño, los grupos de nodos son inmutables. Esto significa que si necesita cambiar algo (además del escalado), como la AMI o el tipo de instancia de un grupo de nodos, deberá crear un nuevo grupo de nodos con los cambios deseados, mover la carga y eliminar el anterior.

## En acción: Manejando nodegroups

1.- Vamos al servio de AWS CloudShell

2.- Creamos un archivo y lo editamos con nano

```
nano my-cluster.yaml
```

Colocamos el siguiente contenido en el archivo

```
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: my-cluster
  region: us-west-2

managedNodeGroups:
  - name: ng-1-mng
    instanceType: t3.large
    desiredCapacity: 2

nodeGroups:
  - name: ng-1-ng
    instanceType: t3.mediun
    desiredCapacity: 2
```

En el archivo especificamos un **managed node group (ng-1-mng)** y un **node group (ng-1-ng)**.

3.- Creamos el cluster con eksctl. Asi que lanzamos el siguiente comando:

```
eksctl create cluster -f my-cluster.yaml
```

![Verificar versiones](/img/3-1.image.jpg)

4.- Verificamos los nodos

```
eksctl get nodegroups --cluster my-cluster
```

![Verificar versiones](/img/3-2.image.jpg)

5.- Vamos a eliminar el node group ng-1-ng.
```
eksctl delete nodegroup ng-1-ng --cluster my-cluster
```
![Verificar versiones](/img/3-3.image.jpg)

6.- Revisamos los nodegroups del cluster my-cluster
```
eksctl get nodegroups --cluster my-cluster
```
![Verificar versiones](/img/3-4.image.jpg)

Verificamos que solo tenemos un nodegroup

7.- Vamos a agregar un nodegroup desde nuestro archivo inicial my-cluster.yaml. Abrimos nano y editamos el archivo colocando el siguiente contenido
```
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: my-cluster
  region: us-west-2

managedNodeGroups:
  - name: ng-1-mng
    instanceType: t3.large
    desiredCapacity: 2
  - name: ng-2-mng
    instanceType: t3.large
    desiredCapacity: 2
    
nodeGroups:
  - name: ng-1-ng
    instanceType: t3.mediun
    desiredCapacity: 2
```

8.- Ahora vamos a crear solo el nodegroup ng-2-mng con el siguiente comando.
```
eksctl create nodegroup --config-file=my-cluster.yaml --include='ng-2-mng' --exclude='ng-1-mng,ng-1-ng'
```
![Verificar versiones](/img/3-5.image.jpg)

9.- Ahora revisamos los nodegroups y deberiamos tener dos
```
eksctl get nodegroups --cluster my-cluster
```
![Verificar versiones](/img/3-6.image.jpg)

10.- Finalmente eliminamos el cluster
```
eksctl delete cluster -f my-cluster.yaml --disable-nodegroup-eviction
```
